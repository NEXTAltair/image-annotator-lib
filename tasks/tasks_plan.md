# タスク計画と進捗トラッカー

## 1. 現状のフォーカスとサマリー (Current Focus and Summary)
- 現在はユニットテストの安定化と主要な型エラーの解消に注力しており、その後BDDステップの再実装に着手予定です。
- ルールとドキュメントの整合性維持も継続的に行っています。

## 2. 詳細タスクリスト・進行状況 (Detailed Task List and Progress)

### 2.1. アクティブなタスク / 残存構築作業 (Active Tasks / Remaining Work)
- [ ] **ユニットテストの全パス:** BDDステップ定義再実装の前提として、既存の全ユニットテストをパスさせる。
- [ ] **BDD ステップ定義の再実装 (Featureファイルは残存)**
  - 既存のFeatureファイルに基づき、品質の高いステップ定義を一から再実装する。
- [ ] **型エラーの解決** - `core/base.py` (`WebApiBaseAnnotator`)
- [ ] **テストリソース クリーンアップ実装 (Phase 2-3)**
  - [ ] フェーズ 3: テストと検証
    - [ ] `uv run pytest` を実行し、テストが正常に完了することを確認。
    - [ ] クリーンアップ処理が意図通り機能しているか確認 (例: キャッシュファイルが適切に削除/復元されるか)。
    - [ ] テスト実行時間やリソース使用量に悪影響がないか確認。
- [ ] **ルール・ドキュメントの再読と更新 (進行中)**
- [ ] **WebAPIアノテーターのテスト安定化 (残作業)**
    - [ ] テスト全体の再実行・安定化確認
    - [ ] ドキュメント間の整合性最終チェック
- [ ] **Google Gemini API・テスト設計関連タスク (残作業)**
    - [ ] テストコードの設計・責務の再確認と修正
    - [ ] テスト・実装・設定ファイルの整合性確認
    - [ ] 必要に応じてdocs/architecture.md, docs/technical.mdも更新
    - [ ] 異常系テストの網羅性強化

### 2.2. バックログ / 今後の展望 (Backlog / Future Outlook)
- **ドキュメント・コード整理:**
    - [ ] ドキュメント整合性チェック・更新:
        - [ ] 過去指摘された矛盾点 (`error-documentation.mdc` セクション2) の解消状況確認
        - [ ] 全ドキュメントのリンク切れ・古情報の確認・修正
        - [ ] `available_api_models.toml` のパス表記統一
        - [ ] 全体的なドキュメントレビューと必要に応じた更新 (継続)
    - [ ] コーディングルール遵守確認・修正:
        - [ ] モダンな型ヒント使用状況の確認・修正
        - [ ] カプセル化原則遵守状況の確認・修正 (特に他クラス内部変数アクセス)
        - [ ] エラーハンドリング方針遵守状況の確認・修正
        - [ ] 半角文字ルール遵守状況の確認・修正
        - [ ] 命名規則 (`*er` 回避など) 遵守状況の確認・修正
        - [ ] `Any` 型使用状況の確認・理由コメント追加 or 型特定
        - [ ] `predict()` オーバーライド禁止ルールの徹底確認
        - [ ] 違反箇所の特定とリファクタリング計画 (必要に応じて)
    - [ ] テストコード整理:
        - [ ] pytest-bdd 日本語+`<param>` 問題の該当箇所特定と対応 (無視/英語化/回避)
- **既存タスク (継続):**
    - [ ] テスト拡充 (BDDステップ再実装後):
        - **単体テスト:**
            - [ ] `ModelLoad` のキャッシュ戦略(LRU、CPU 退避、メモリ逼迫時の挙動)を検証するテストケースを追加。
            - [ ] 各フレームワーク別ローダー (`TransformersLoader`, `ONNXLoader` 等) の正常系・異常系テストを追加。
            - [ ] `registry.py` の動的クラス検出・登録ロジックのテストを追加。
            - [ ] 各具象モデルクラス (`models/` 配下) の主要メソッドに対するテストを追加・拡充。
        - **結合テスト:**
            - [ ] BDDステップ再実装後、`api.annotate` 関数のテストシナリオを拡充 (複数モデル同時実行、pHash 生成失敗ケース、エラーハンドリング、Web API モデルなど)。
            - [ ] 各モデルのエラーハンドリング (特に OOM, APIエラー) が `annotate` 関数レベルで適切に処理され、結果に反映されるか検証するシナリオを追加。
            - [ ] 設定ファイル (`annotator_config.toml`) の様々なパターン (オプション指定有無など) に対するテストを追加。
        - **カバレッジ:** `pytest --cov` を実行し、テストカバレッジを確認・向上させる。
    - [ ] ドキュメント最終化:
        - [ ] `docs/` 内の各ドキュメント (API リファレンス、設定ガイド、モデル説明など) の内容を、最新のコード実装と完全に一致するように最終レビュー。
        - [ ] 全公開クラス・メソッド・関数の Docstring の網羅性と正確性を確認・修正。
        - [ ] 必要に応じてアーキテクチャ図などを `docs/` 内に追記・更新。
        - [ ] 日本語 README (`README-JP.md`) を作成または更新。
    - [ ] 依存関係の最終整理:
        - [ ] `pyproject.toml` の依存関係 (`dependencies`, `dev-dependencies`) を最終確認し、不要なライブラリがあれば削除。バージョン指定が適切か確認。
    - [ ] 実環境での動作確認:
        - [ ] ライブラリを実際に使用する環境 (例: LoRAIro) で `annotate` 関数を呼び出し、主要なモデルが問題なく動作するか確認。パフォーマンスやメモリ使用量についても簡易的に確認。
    - [ ] 静的解析エラーの完全解消:
        - [ ] `ruff check` および `mypy` を実行し、報告されるエラーや警告が完全に解消されていることを確認。(# type: ignore や # noqa が残っていないか確認)
    - [ ] 設定ファイル (`annotator_config.toml`) の構造改善検討 (将来対応):
        - [ ] 現在の `annotator_config.toml` の構造は読みにくいため、将来的に改善を検討する。具体的な改善案については別途相談する。

## 3. 完了事項 (Completed Tasks)
- [x] ModelLoad のリファクタリングとメモリ管理ロジックの改善 (初期実装完了, 2024-04-02 -> 2025-04-05)
- [x] Memory Bank 更新 (当時の状況記録, 2025-04-05)
- [x] `memory-bank/` から推奨メモリファイルへの情報移行 (2025-04-29)
- [x] 設定ドキュメント (V2) に基づくファイル構造・ドキュメント整理 (主要部分完了, `memory-bank` 削除, `docs/` 内不要ファイル削除, 2025-04-30)
- [x] docs/ディレクトリのドキュメント整理・.gitignoreの見直し・models/ディレクトリ運用方針の明確化(2025-04-30)
- [x] BDDステップ定義ファイルおよび関連conftest.pyの削除 (2025-05-XX)
- [x] ドキュメント / ルールファイルの整合性チェック (関連部分完了 2025-05-07)
- [x] テストクリーンナップタスク完了 (2025-05-04)
- [x] WebAPIアノテーターのテスト安定化タスク (初期対応完了 2025-05-08: 初期化ロジック修正、TOML反映処理追加、記述ミス修正、型・属性アクセス誤り修正)
- [x] Google Gemini API・テスト設計関連タスク (初期対応完了 2025-05-08: google-genai バージョンアップ対応、エラーハンドリング・テスト設計見直し、SDK起因問題解消確認、関連ドキュメント更新)
- [x] テストリソースクリーンアップ戦略の策定と実装 (フェーズ 1 および フェーズ 2 完了)
    - [x] フェーズ 1: 副作用特定と要件定義
    - [x] フェーズ 2: クリーンアップ実装 (`reset_model_load_state`, `manage_api_cache_file` フィクスチャ実装)

## 4. 既知の問題点 (Known Issues)
- (ここに、純粋な未解決の問題点やバグを記載)
- (例: WebAPIアノテーターのテストで稀にタイムアウトが発生する (原因調査中))

## [2025-05-10] Google Gemini annotator レスポンス型・エラーハンドリング設計変更

### 完了タスク
- google_api.py のレスポンス型を WebApiAnnotationOutput (annotation: dict[str, Any] | None, error: str | None) に統一
- スキーマ不一致・APIエラー時のエラー格納設計実装
- テスト・型定義の修正
- ドキュメント(technical.md, architecture.md, active_context.md)への記録

### 今後のタスク
- 他WebAPIアノテーターへの同様の設計適用(必要に応じて)
- 設計方針・ドキュメントの定期的な見直し

## 2025-05-10 OpenAIApiAnnotator関連タスク

- OpenAI API画像入力（base64）はimage_url: dict型で渡すよう修正
- 型エラー（ImageURL型）を辞書型指定で解消
- 構造化出力モデルをAnnotationSchema（webapi_shared.py）に統一
- _run_inference/_format_predictionsの型安全・エラーハンドリングを整理
- ユニットテスト（test_openai_api_response.py）を追加し、正常系・異常系・API例外を網羅

## 2025-05-10 AnthropicApiAnnotator関連タスク（テスト用ToolUseBlockクラス名修正・型判定整理）

- テスト用ダミークラスのクラス名をToolUseBlockに合わせ、type(obj).__name__ == "ToolUseBlock" の判定に合致させることでテストがパス。
- _format_predictionsでAnnotationSchema型を許容し、APIレスポンスの型安全性・一貫性を向上。
- これにより、Anthropic/Claude系APIの構造化出力テストが全てパス。

## 2025-05-10 annotator_webapi.py から OpenAIApiAnnotator・AnthropicApiAnnotator 分離タスク

- annotator_webapi.py から OpenAIApiAnnotator を openai_api_response.py へ、AnthropicApiAnnotator を anthropic_api.py へ分離
- 分離に伴い、型定義・エラーハンドリング・テストを整理
- 共通スキーマ（AnnotationSchema）は webapi_shared.py に集約
- テスト用ダミークラスのクラス名・型判定ロジックを実装と一致させ、テストの信頼性を担保
- テスト全パスを確認

### 今後のタスク
- 他API（Google, OpenRouter等）も同様の分離・整理を検討
- ドキュメント・設計方針の定期的な見直し

---