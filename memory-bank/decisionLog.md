## ドキュメント統合計画

1.  **現在のドキュメント構造の把握**:
    *   `docs/README.md` ファイルを再度確認し、ドキュメントの全体構造を把握します。
    *   `docs` ディレクトリのファイルリストを確認し、新規または変更されたファイルがないか確認します。
    *   `docs/EXPLANATION/integrated_architecture.md` ファイル (もし存在すれば) を確認します。これはリファクタリング後の統合されたアーキテクチャのドキュメントである可能性があります。

2.  **リファクタリングの詳細の確認**:
    *   ユーザーにリファクタリングの主な内容と、ドキュメントのどの部分が特に影響を受けたか質問します。
    *   リファクタリングによってドキュメントにどのような変更が加えられたかを明確にします。

3.  **ドキュメント更新計画の作成**:
    *   リファクタリングによる変更に基づいて、ドキュメントのどの部分を更新する必要があるかを特定します。
    *   更新の優先順位を決定します (例: 新機能、重要な変更点など)。
    *   ドキュメント更新のスケジュールを作成します (必要に応じて)。

4.  **ドキュメント更新の実施**:
    *   `read_file` ツールを使用して、更新対象のドキュメントファイルの内容を読み込みます。
    *   `apply_diff` ツールを使用して、ドキュメントに必要な変更を適用します。
    *   新しいドキュメントを追加する必要がある場合は、`write_to_file` ツールを使用します。

5.  **ドキュメント更新の確認**:
    *   更新されたドキュメントが正しく記述されているか、誤りや矛盾がないか確認します。
    *   可能であれば、ドキュメントをローカルでビルドし、ウェブサイトに公開する前にプレビューします。

6.  **ドキュメント更新の完了**:
    *   更新されたドキュメントをウェブサイトまたは適切な場所に公開します。
    *   ユーザーにドキュメント更新の完了を報告します。

**Mermaid図**

```mermaid
graph LR
    A[現在のドキュメント構造の把握] --> B{リファクタリングの詳細の確認};
    B --> C[ドキュメント更新計画の作成];
    C --> D[ドキュメント更新の実施];
    D --> E[ドキュメント更新の確認];
    E --> F[ドキュメント更新の完了];

## ドキュメント削減の決定と計画 (2025-04-18)

**背景:**
ユーザーより、ドキュメントのファイル数が多すぎる（11ファイル）ため、量を約三分の一程度に削減したいとのフィードバックを受けました。

**決定:**
ドキュメントのファイル数を削減し、内容を整理統合します。目標ファイル数は約7ファイルとします。

**計画:**
1.  **必須ドキュメントの維持:** 以下のファイルはライブラリの利用・開発に必須であるため維持します。
    *   `docs/README.md` (ドキュメント概要)
    *   `docs/getting_started.md` (入門ガイド)
    *   `docs/developer_guide.md` (開発者ガイド)
    *   `docs/REFERENCE/api.md` (APIリファレンス)
    *   `docs/REFERENCE/configuration.md` (設定ファイル仕様)
    *   `docs/REFERENCE/models.md` (サポートモデル詳細)
2.  **解説・設計関連ドキュメントの統合:** 「解説」セクションのファイル (`design_decisions.md`, `legacy_info.md`, `refactoring.md`) および `web_api_annotator_design.md` の内容を、`docs/EXPLANATION/integrated_architecture.md` に統合します。
    *   `docs/EXPLANATION/integrated_architecture.md` を中心に、設計決定の背景、ModelLoad クラスの詳細、Web API アノテーター設計、旧ライブラリ情報の要約を含めるように内容を再構成します。
3.  **不要ファイルの削除:** 統合元となった以下のファイルを削除します。
    *   `docs/EXPLANATION/design_decisions.md`
    *   `docs/EXPLANATION/legacy_info.md`
    *   `docs/EXPLANATION/refactoring.md`
    *   `docs/web_api_annotator_design.md`
4.  **README.md の更新:** 削除・統合されたファイルへのリンクを修正します。
5.  **統合ドキュメントの確認:** 統合後の `integrated_architecture.md` の内容を確認し、情報が網羅されており、かつ簡潔にまとめられていることを確認します。

#### [バグ修正] ログ出力が多重になる問題の修正

- **発生日:** 2025-04-19
- **影響範囲:** 全ログ出力（ファイル・コンソール）
- **現象:** ログが同じ内容で2回以上出力される
- **原因:** `core/utils.py` の logger 初期化処理が、複数回importされることで何度も実行され、logger.addが多重に呼ばれていた
- **修正方針:**
  1. logger初期化処理を `init_logger` 関数として分離し、多重初期化を防ぐガードを追加
  2. loggerの初期化は `__init__.py` でプロセス起動時に1回だけ明示的に呼ぶ
  3. loggerのimport経路を統一し、絶対/相対importの混在を避ける
- **修正理由:** ログの可読性・運用性向上、不要なI/O負荷の削減
- **影響:** 既存のlogger利用コードには影響なし。ログ出力が正常化される

#### [設計変更] レジストリ・logger初期化の即時実行廃止と明示的初期化への移行

- **発生日:** 2025-04-19
- **内容:**
  - `core/registry.py` の末尾で行っていた logger によるログ出力および `register_annotators()` の即時実行（import時自動実行）を廃止。
  - 代わりに、logger初期化（`init_logger()`）→レジストリ初期化（`register_annotators()`）を明示的な初期化関数でのみ実行する設計に変更。
- **理由:**
  - loggerのsink設定前にログ出力が発生し、ログが出力されない問題を根本解決するため。
  - import時の副作用（グローバル状態変更や重い処理）を排除し、テスト・再利用性・保守性を向上させるため。
  - Pythonのベストプラクティス（import時は副作用を持たせない）に従うため。
- **影響:**
  - logger/レジストリ初期化はエントリーポイントやAPI利用時に明示的に呼ぶ必要がある。
  - 既存のimport時自動初期化に依存したコードは修正が必要。
  - ログ出力の信頼性・初期化順序の一貫性が向上。
